sudo: required
dist: trusty
language: python
python:
  - "2.7"
services:
  - docker
env:
  global:
    - PATH="/usr/bin:$PATH"

before_script:
  # Pull container.
  - 'docker pull hhercules/docker-${distro}-ansible:latest'

before_install:
    # Ansible doesn't play well with virtualenv
  - deactivate
  - sudo apt-get update -qq
  - sudo apt-get install -y -o Dpkg::Options::="--force-confnew" docker-engine
  - for role in $(ls roles/); do if [ -n  `git show --name-only --oneline "${TRAVIS_COMMIT}" |egrep -v '^.{7} ' |tr '\n' ' ' 2>/dev/null` ]; then roles=$role; echo "${roles}"; fi; done
install:
  - sudo pip install docker-py
    # software-properties-common for ubuntu 14.04
    # python-software-properties for ubuntu 12.04
  - sudo apt-get install -y sshpass software-properties-common python-software-properties
  - sudo apt-add-repository -y ppa:ansible/ansible
  - sudo apt-get update -qq
  - sudo apt-get install -y ansible
  - sudo rm /usr/bin/python && sudo ln -s /usr/bin/python2.7 /usr/bin/python
  - ansible --version

script:
  - echo "${TRAVIS_BRANCH}"
  - if [ "${TRAVIS_BRANCH}" == "master" ]; then for r in $(ls roles); do ansible-playbook roles/$r/test/test.yml; done; else ansible-playbook roles/${roles}/test/test.yml --syntax-check; ansible-playbook roles/${roles}/test/test.yml; fi
